#!/bin/bash

# =============================================================================
# Script de Inicializa√ß√£o para Container NestJS (Desenvolvimento)
# =============================================================================
# Este script √© executado quando o container inicia e:
# - Instala/atualiza depend√™ncias se necess√°rio
# - Executa migrations (opcional)
# - Inicia aplica√ß√£o em modo desenvolvimento com hot-reload
# =============================================================================

set -e  # Sai em caso de erro

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Fun√ß√µes de log
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# =============================================================================
# 1. Verificar e Instalar Depend√™ncias
# =============================================================================
log_info "Verificando depend√™ncias..."

# Verifica se node_modules existe E se package.json foi modificado recentemente
if [ ! -d "node_modules" ] || [ "package.json" -nt "node_modules" ]; then
    log_info "üì¶ Instalando/atualizando depend√™ncias (npm ci)..."
    npm ci --quiet

    if [ $? -eq 0 ]; then
        log_info "‚úÖ Depend√™ncias instaladas com sucesso"
    else
        log_error "‚ùå Falha ao instalar depend√™ncias"
        exit 1
    fi
else
    log_info "‚úÖ Depend√™ncias j√° atualizadas"
fi

# =============================================================================
# 2. Aguardar Servi√ßos Externos (Database, Redis, etc.)
# =============================================================================
log_info "Aguardando servi√ßos externos..."

# PostgreSQL
if [ ! -z "$DB_HOST" ]; then
    log_info "Aguardando PostgreSQL em $DB_HOST:${DB_PORT:-5432}..."

    max_attempts=30
    attempt=1

    while ! nc -z "$DB_HOST" "${DB_PORT:-5432}" 2>/dev/null; do
        if [ $attempt -ge $max_attempts ]; then
            log_error "‚ùå Timeout aguardando PostgreSQL"
            exit 1
        fi

        log_warn "PostgreSQL n√£o dispon√≠vel, tentativa $attempt/$max_attempts..."
        sleep 2
        ((attempt++))
    done

    log_info "‚úÖ PostgreSQL dispon√≠vel"
fi

# Redis
if [ ! -z "$REDIS_HOST" ]; then
    log_info "Aguardando Redis em $REDIS_HOST:${REDIS_PORT:-6379}..."

    max_attempts=30
    attempt=1

    while ! nc -z "$REDIS_HOST" "${REDIS_PORT:-6379}" 2>/dev/null; do
        if [ $attempt -ge $max_attempts ]; then
            log_error "‚ùå Timeout aguardando Redis"
            exit 1
        fi

        log_warn "Redis n√£o dispon√≠vel, tentativa $attempt/$max_attempts..."
        sleep 2
        ((attempt++))
    done

    log_info "‚úÖ Redis dispon√≠vel"
fi

# RabbitMQ
if [ ! -z "$RABBITMQ_HOST" ]; then
    log_info "Aguardando RabbitMQ em $RABBITMQ_HOST:${RABBITMQ_PORT:-5672}..."

    max_attempts=30
    attempt=1

    while ! nc -z "$RABBITMQ_HOST" "${RABBITMQ_PORT:-5672}" 2>/dev/null; do
        if [ $attempt -ge $max_attempts ]; then
            log_error "‚ùå Timeout aguardando RabbitMQ"
            exit 1
        fi

        log_warn "RabbitMQ n√£o dispon√≠vel, tentativa $attempt/$max_attempts..."
        sleep 2
        ((attempt++))
    done

    log_info "‚úÖ RabbitMQ dispon√≠vel"
fi

# =============================================================================
# 3. Executar Migrations (Opcional - descomente se necess√°rio)
# =============================================================================
# log_info "Executando migrations..."
# npm run migrate
#
# if [ $? -eq 0 ]; then
#     log_info "‚úÖ Migrations executadas com sucesso"
# else
#     log_warn "‚ö†Ô∏è  Erro ao executar migrations (continuando...)"
# fi

# =============================================================================
# 4. Iniciar Aplica√ß√£o
# =============================================================================
log_info "üöÄ Iniciando aplica√ß√£o em modo desenvolvimento..."
log_info "NODE_ENV: ${NODE_ENV:-development}"
log_info "Porta: ${APP_PORT:-3000}"

# Inicia NestJS em modo watch (hot-reload)
npm run start:dev

# Se start:dev falhar, mant√©m container ativo para debugging
if [ $? -ne 0 ]; then
    log_error "‚ùå Falha ao iniciar aplica√ß√£o"
    log_warn "Container permanecer√° ativo para debugging"
    tail -f /dev/null
fi
